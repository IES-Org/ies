name: Update Documentation

on:
  repository_dispatch:
    types: [update-docs]

jobs:
  update-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.IES_ONTOLOGIES_PAT }}

      - name: Get repository name
        id: repo-name
        run: |
          REPO_FULL_NAME="${{ github.event.client_payload.repo }}"
          REPO_NAME=$(echo $REPO_FULL_NAME | cut -d'/' -f2)
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT

      - name: Checkout source repository
        uses: actions/checkout@v3
        with:
          repository: ${{ github.event.client_payload.repo }}
          ref: ${{ github.event.client_payload.ref }}
          path: temp-docs
          token: ${{ secrets.IES_ONTOLOGIES_PAT }}

      - name: Copy documentation
        run: |
          # Get the repository name without 'ies-' prefix if it exists
          DEST_DIR=$(echo "${{ steps.repo-name.outputs.repo_name }}" | sed 's/^ies-//')
          
          # Remove old content
          rm -rf "docs/$DEST_DIR"/*
          
          # Copy new content
          cp -r temp-docs/${{ github.event.client_payload.path }}/* "docs/$DEST_DIR"/ || true
          
          # Cleanup
          rm -rf temp-docs

      - name: Commit and push if changed
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Check if there are changes
          if [[ -n "$(git status --porcelain)" ]]; then
            git add -A
            git commit -m "Update docs from ${{ github.event.client_payload.repo }}@${{ github.event.client_payload.ref }}"
            git push
          fi

      - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                node-version: '18'

            - name: Install dependencies
              run: npm install

            - name: Build ontology documentation
              run: node build-docs.js

            - name: Copy documentation
              run: |
                # Get the repository name without 'ies-' prefix if it exists
                DEST_DIR=$(echo "${{ steps.repo-name.outputs.repo_name }}" | sed 's/^ies-//')
